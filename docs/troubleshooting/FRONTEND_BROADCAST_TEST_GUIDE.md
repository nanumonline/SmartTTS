# 프론트엔드 송출 기능 테스트 가이드

## 📋 적용된 기능 요약

### 1. **송출 다이얼로그 (BroadcastDialog)**
   - 위치: `src/components/BroadcastDialog.tsx`
   - 기능:
     - 즉시 송출: 생성된 음원을 즉시 선택한 채널로 전송
     - 지연 송출: 10분/30분/60분 후 또는 사용자 지정 시간 후 송출
     - 스케줄 송출: 날짜와 시간을 지정하여 송출 (스케줄 관리 페이지에서 처리)
     - 플레이어 송출 옵션: 체크 시 고객 구분 정보 입력 필드 표시
     - 고객 구분 정보: 고객 ID, 고객명, 구분 코드, 메모

### 2. **스케줄 관리 페이지 개선**
   - 위치: `src/pages/ScheduleManagerPage.tsx`
   - 변경사항:
     - 음원 목록 테이블에 "송출" 버튼 추가
     - 송출 버튼 클릭 시 BroadcastDialog 열림
     - 송출 성공 후 스케줄 목록 자동 새로고침 (즉시, 5초 후, 10초 후)
     - 30초마다 자동 새로고침 유지

### 3. **dbService 송출 함수**
   - 위치: `src/services/dbService.ts`
   - 추가된 함수:
     - `broadcastImmediately(options)`: 즉시 송출
     - `broadcastDelayed(options, delayMinutes)`: 지연 송출
     - `broadcastScheduled(options, scheduledTime)`: 스케줄 송출
   - 모든 함수는 프론트에서 직접 Edge Function(`broadcast-now`) 호출

### 4. **플레이어 개선 (PC)**
   - 위치: `api/broadcast/player-pc.html`
   - 변경사항:
     - 폴링 간격 선택 드롭다운 추가 (5초, 10초, 30초)
     - 즉시 송출 감지 시 자동으로 빠른 폴링 모드(5초)로 전환
     - 오래된 오디오만 있으면 일반 폴링 모드로 복귀

---

## 🧪 테스트 프로세스

### **프리퀴지트 (사전 준비)**

1. **음원 생성**
   ```
   ✓ 음성 생성 페이지에서 음원 생성 완료
   ✓ 생성된 음원이 "생성 내역"에 표시되는지 확인
   ```

2. **채널 설정**
   ```
   ✓ 전송 설정 페이지 접속
   ✓ 채널 생성 (예: "PC 방송", type: "pc", endpoint: "https://nanum.online/tts/api/broadcast")
   ✓ 채널 활성화 확인
   ```

3. **플레이어 준비 (PC 방송 테스트 시)**
   ```
   ✓ player-pc.html 페이지 열기
   ✓ 플레이어가 정상적으로 로드되는지 확인
   ✓ 폴링이 작동하는지 확인 (오디오 목록 표시)
   ```

---

### **테스트 시나리오 1: 즉시 송출 (기본)**

**목표**: 생성된 음원을 즉시 선택한 채널로 송출

**단계**:
1. **스케줄 관리 페이지 접속**
   - URL: `http://localhost:8000/schedule-manager` 또는 프로덕션 URL
   - 좌측 하단 "새 스케줄 만들기" 버튼 클릭

2. **음원 선택**
   - 음원 목록에서 원하는 음원 찾기
   - 음원 행 오른쪽의 **"송출" 버튼 클릭**

3. **송출 다이얼로그 확인**
   - 다이얼로그가 열리고 다음 항목 확인:
     - 스케줄 이름 입력 필드
     - 송출 채널 선택 드롭다운
     - 송출 방식: "즉시 송출" / "지연 송출" 라디오 버튼
     - 플레이어 송출 체크박스

4. **즉시 송출 설정**
   - 스케줄 이름 입력 (예: "테스트 즉시 송출")
   - 송출 채널 선택 (예: "PC 방송 (pc)")
   - 송출 방식: **"즉시 송출"** 선택
   - 플레이어 송출: 체크 안 함 (기본 테스트)

5. **송출 실행**
   - **"송출" 버튼 클릭**
   - 성공 토스트 메시지 확인: "즉시 송출이 시작되었습니다."

6. **결과 확인**
   - **플레이어 (player-pc.html)**:
     - 5초 이내에 새 오디오 파일 감지
     - 자동으로 재생 시작
     - 빠른 폴링 모드로 전환 (5초 간격)
     - 상태: "재생 중: [스케줄 이름]"
   - **서버 로그 (선택사항)**:
     - Hostinger File Manager에서 `audio` 폴더 확인
     - 파일명: `{스케줄이름}_YYYY-MM-DD_HH-MM-SS.mp3` 형식

**예상 결과**:
- ✅ 즉시 송출 성공 메시지 표시
- ✅ 플레이어에서 음원 재생 시작
- ✅ 빠른 폴링 모드 자동 전환

---

### **테스트 시나리오 2: 지연 송출**

**목표**: 생성된 음원을 10분 후 송출

**단계**:
1. **스케줄 관리 페이지 접속**
   - 음원 목록에서 원하는 음원 찾기
   - **"송출" 버튼 클릭**

2. **지연 송출 설정**
   - 스케줄 이름 입력 (예: "테스트 지연 송출")
   - 송출 채널 선택
   - 송출 방식: **"지연 송출"** 선택
   - 지연 시간: **"10분"** 버튼 클릭 또는 직접 입력

3. **송출 실행**
   - **"송출" 버튼 클릭**
   - 성공 토스트 메시지 확인: "10분 후 송출이 예약되었습니다."

4. **스케줄 확인**
   - 스케줄 관리 페이지에서 새 스케줄 확인
   - 상태: "예약됨" (scheduled)
   - 예약 시간: 현재 시간 + 10분

5. **10분 후 결과 확인**
   - 스케줄 상태가 "전송됨" (sent)으로 변경되는지 확인
   - 플레이어에서 음원 재생 시작 확인
   - 서버에 오디오 파일 생성 확인

**예상 결과**:
- ✅ 지연 송출 예약 성공 메시지 표시
- ✅ 스케줄 목록에 예약된 스케줄 추가
- ✅ 10분 후 자동 송출 및 상태 업데이트

---

### **테스트 시나리오 3: 플레이어 송출 (고객 구분 정보 포함)**

**목표**: 플레이어 송출 옵션 선택 시 고객 정보 포함하여 송출

**단계**:
1. **송출 다이얼로그 열기**
   - 음원 선택 → **"송출" 버튼 클릭**

2. **플레이어 송출 설정**
   - 스케줄 이름 입력 (예: "고객 구분 테스트")
   - 송출 채널 선택
   - 송출 방식: "즉시 송출" 선택
   - **"플레이어 송출" 체크박스 체크** ✅

3. **고객 구분 정보 입력**
   - 고객 ID: `CUST001` 입력
   - 고객명: `테스트 고객` 입력
   - 구분 코드: `VIP` 입력
   - 메모: `중요 고객` 입력 (선택사항)

4. **송출 실행**
   - **"송출" 버튼 클릭**
   - 성공 메시지 확인

5. **고객 정보 확인**
   - **플레이어 (player-pc.html)**:
     - 오디오 목록에서 스케줄 이름 표시 확인
     - 현재 재생 정보에 고객 정보 표시 (추후 구현 가능)
   - **서버 로그 (선택사항)**:
     - POST 요청 헤더 확인:
       - `X-Customer-Id: CUST001`
       - `X-Customer-Name: 테스트 고객`
       - `X-Category-Code: VIP`
       - `X-Customer-Memo: 중요 고객`

**예상 결과**:
- ✅ 고객 정보 입력 필드 표시
- ✅ 송출 성공 시 고객 정보가 헤더에 포함되어 전송
- ✅ 플레이어에서 고객 정보 활용 가능 (추후 구현)

---

### **테스트 시나리오 4: 폴링 간격 조정 (플레이어)**

**목표**: 플레이어 폴링 간격을 동적으로 조정

**단계**:
1. **플레이어 페이지 접속**
   - URL: `https://nanum.online/tts/api/broadcast/player-pc.html`

2. **폴링 간격 확인**
   - 현재 폴링 간격: 기본값 10초
   - 드롭다운에서 선택 가능: "5초", "10초", "30초"

3. **폴링 간격 변경**
   - 드롭다운에서 **"5초"** 선택
   - 콘솔 로그 확인: `폴링 간격 변경: 일반 5000ms, 빠른 2500ms`
   - 실제 폴링 간격이 5초로 변경되는지 확인

4. **즉시 송출 감지 테스트**
   - 스케줄 관리 페이지에서 즉시 송출 실행
   - 플레이어가 5초 내에 새 오디오 감지
   - 자동으로 빠른 폴링 모드(2.5초)로 전환되는지 확인
   - 콘솔 로그: `즉시 송출 감지: 빠른 폴링 모드로 전환`

5. **일반 폴링 모드 복귀 확인**
   - 5분 이상 오래된 오디오만 있는 경우
   - 자동으로 일반 폴링 모드로 복귀
   - 콘솔 로그: `일반 폴링 모드로 복귀`

**예상 결과**:
- ✅ 폴링 간격 동적 변경 가능
- ✅ 즉시 송출 감지 시 자동 빠른 폴링 모드 전환
- ✅ 오래된 오디오만 있을 시 일반 폴링 모드로 복귀

---

### **테스트 시나리오 5: 송출 상태 실시간 추적**

**목표**: 송출 후 상태 변화를 실시간으로 확인

**단계**:
1. **스케줄 관리 페이지 준비**
   - 페이지 열기
   - 브라우저 개발자 도구 열기 (F12)
   - Network 탭 활성화

2. **즉시 송출 실행**
   - 음원 선택 → 송출 버튼 → 즉시 송출 실행

3. **자동 새로고침 확인**
   - **즉시 새로고침**: 송출 성공 후 즉시 스케줄 목록 업데이트
   - **5초 후 새로고침**: 자동으로 스케줄 목록 다시 로드
   - **10초 후 새로고침**: 추가로 스케줄 목록 다시 로드
   - Network 탭에서 `tts_schedule_requests` API 호출 확인

4. **상태 변화 확인**
   - 스케줄 목록에서 새 스케줄 확인
   - 상태가 "예약됨" → "전송됨"으로 변경되는지 확인
   - 전송 시간(`sent_at`)이 업데이트되는지 확인

**예상 결과**:
- ✅ 송출 성공 후 즉시 스케줄 목록 새로고침
- ✅ 5초, 10초 후 추가 새로고침으로 상태 업데이트 확인
- ✅ 상태가 실시간으로 변경되는 것 확인

---

## 🐛 문제 해결

### **송출 버튼이 보이지 않는 경우**
- ✅ 음원 목록이 로드되었는지 확인
- ✅ 브라우저 캐시 클리어 후 새로고침
- ✅ 개발자 도구 콘솔에서 에러 확인

### **송출 다이얼로그에서 채널이 보이지 않는 경우**
- ✅ 전송 설정 페이지에서 채널이 생성되었는지 확인
- ✅ 채널이 활성화(enabled: true)되어 있는지 확인
- ✅ 채널 endpoint가 설정되어 있는지 확인

### **즉시 송출은 성공했지만 플레이어에서 재생되지 않는 경우**
- ✅ 플레이어 페이지가 열려있는지 확인
- ✅ 플레이어 폴링이 작동하는지 확인 (콘솔 로그 확인)
- ✅ 서버에 오디오 파일이 생성되었는지 확인 (File Manager)
- ✅ 오디오 파일 크기가 100 bytes 이상인지 확인

### **지연 송출이 예약되었지만 실행되지 않는 경우**
- ✅ `execute-schedules` Edge Function이 정상 작동하는지 확인
- ✅ Supabase 로그에서 `execute-schedules` 실행 로그 확인
- ✅ 스케줄 시간이 올바르게 설정되었는지 확인 (UTC vs KST)
- ✅ `pg_cron` 작업이 정상 작동하는지 확인

---

## 📝 체크리스트

### **기본 기능 테스트**
- [ ] 즉시 송출 실행 및 성공 메시지 확인
- [ ] 지연 송출 예약 및 실행 확인
- [ ] 플레이어 송출 옵션 선택 시 고객 정보 입력 필드 표시
- [ ] 송출 성공 후 스케줄 목록 자동 새로고침 확인

### **플레이어 기능 테스트**
- [ ] 폴링 간격 조정 (5초, 10초, 30초)
- [ ] 즉시 송출 감지 시 빠른 폴링 모드 전환
- [ ] 일반 폴링 모드 복귀 확인
- [ ] 오디오 자동 재생 확인

### **상태 추적 테스트**
- [ ] 송출 후 즉시 상태 업데이트 확인
- [ ] 5초, 10초 후 추가 새로고침 확인
- [ ] 스케줄 상태 변화 (예약됨 → 전송됨) 확인

### **에러 처리 테스트**
- [ ] 채널이 없는 경우 에러 메시지 확인
- [ ] 고객 정보 필수 필드 누락 시 에러 메시지 확인
- [ ] 네트워크 오류 시 에러 메시지 확인

---

## 🚀 다음 단계

### **추가 개선 사항**
1. **AudioHistoryPage에 송출 버튼 추가**
   - 생성 내역 페이지에서도 송출 기능 제공
2. **송출 이력 추적**
   - 송출 성공/실패 이력 별도 테이블로 관리
3. **실시간 알림**
   - WebSocket 또는 SSE를 통한 실시간 상태 업데이트
4. **송출 통계**
   - 일별/주별/월별 송출 통계 대시보드

---

**테스트 완료 후 모든 체크리스트 항목을 확인하고, 문제가 발견되면 즉시 리포트해주세요!** ✅

